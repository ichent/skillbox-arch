```mermaid

graph TD
    %% Стилизация узлов
    classDef client fill:#e1f5fe,stroke:#01579b,stroke-width:2px;
    classDef gateway fill:#fff9c4,stroke:#fbc02d,stroke-width:2px;
    classDef service fill:#e8f5e9,stroke:#2e7d32,stroke-width:2px;
    classDef db fill:#f3e5f5,stroke:#7b1fa2,stroke-width:2px,shape:cylinder;
    classDef infra fill:#eceff1,stroke:#546e7a,stroke-width:2px,stroke-dasharray: 5 5;

    subgraph Client_Layer [1. Уровень клиента / Client Layer]
        direction TB
        Sensors(Внешние датчики /<br/> Health API)

        subgraph Mobile_App [Мобильное приложение Flutter]
            Ingestion[Модуль сбора телеметрии]
            LocalDB[(Локальная БД <br/> Realm/SQLite)]
        end

        Sensors -->|Bluetooth / API| Ingestion
        Ingestion <--> LocalDB
    end

    subgraph Gateway_Layer [2. Уровень шлюза / API Gateway]
        APIGW[Nginx / Kong <br/> SSL Termination, Rate Limiting]:::gateway
    end

    Client_Layer -->|HTTPS / REST| APIGW

    subgraph K8s_Cluster [Kubernetes Cluster]
        direction TB

        subgraph Message_Bus [Асинхронное взаимодействие]
            Broker{Message Broker <br/> RabbitMQ / Kafka}:::infra
        end

        subgraph Service_Identity
            IdSvc[Identity Service <br/> Python/FastAPI]:::service
            IdDB[(User DB <br/> PostgreSQL)]:::db
            IdSvc --> IdDB
        end

        subgraph Service_Training
            TrainSvc[Training Core Service <br/> Python/FastAPI]:::service
            TrainDB[(Telemetry DB <br/> TimescaleDB)]:::db
            TrainSvc --> TrainDB
        end

        subgraph Service_Inventory
            InvSvc[Inventory Service <br/> Python/FastAPI]:::service
            InvDB[(Inventory DB <br/> PostgreSQL)]:::db
            InvSvc --> InvDB
        end

        subgraph Service_Gamification
            GameSvc[Gamification Service <br/> Python/FastAPI]:::service
            GameCache[(Leaderboards <br/> Redis)]:::db
            GameSvc --> GameCache
        end

        subgraph Service_Social
            SocSvc[Social Service <br/> Python/FastAPI]:::service
            SocDB[(Social DB <br/> PostgreSQL)]:::db
            SocSvc --> SocDB
        end

        subgraph Service_Notification
            NotifSvc[Notification Service]:::service
            FCM(Firebase FCM / <br/> SMTP)
            NotifSvc --> FCM
        end

        %% Синхронные связи
        APIGW --> IdSvc
        APIGW --> TrainSvc
        APIGW --> InvSvc
        APIGW --> GameSvc
        APIGW --> SocSvc

        %% Асинхронные связи (Event Driven)
        TrainSvc -.->|TrainingFinished Event| Broker
        Broker -.->|Subscribe| InvSvc
        Broker -.->|Subscribe| GameSvc
        Broker -.->|Subscribe| NotifSvc

        %% Хранилище файлов
        S3[(Object Storage <br/> MinIO / S3)]:::db
        SocSvc --> S3
        TrainSvc --> S3
    end

    %% Привязка стилей
    class Mobile_App,Ingestion client;
